"use strict";(function(){function t(){e.init(),e.startVideo(),e.startPeoplesCount(),e.startHeatMap(e.HeatMapTypeEnum.count)}var e=function(){function t(t){var e="multipart/form-data; boundary=myboundary",n=e.match(/boundary=(?:"([^"]+)"|([^;]+))/i),r="";if(!n)throw new Error("Bad content-type header, no multipart boundary");var i=n[1]||n[2],i="\r\n--"+i;r=t,r="\r\n"+r;var l=r.split(new RegExp(i)),o=l[1].split("\r\n\r\n");return o[2]}function e(){l=document.getElementById("globalCameraView"),i=document.getElementById("camera"),c.init(),p.init(),c.setScreenSize(l.clientWidth),p.setScreenSize(l.clientWidth)}function n(t){l.width.baseVal.value=t,l.height.baseVal.value=t,c.setScreenSize(l.clientWidth),p.setScreenSize(l.clientWidth)}function r(){var t=new Date;t="?"+t.getTime();var e=o+t,n=new Image;n.onload=function(){i.setAttribute("xlink:href",e)},n.src=e}var i,l,o="http://172.21.254.60/cgi-bin/camera?stream=2",s="http://www.w3.org/2000/svg",a=500,u=null,c=function(){function e(){c=document.getElementById("matrix")}function n(t){y=t/64,p&&(clearTimeout(f),u(),o())}function r(e){for(var n=t(e),r=0,i=0,l=[],o=n.split("\r\n"),s=1;s<o.length-1;s++)for(var a=o[s].split(","),u=0;u<a.length;u++){var c=parseInt(a[u]);c>r&&(r=c),c>0&&(0==i?i=c:i>c&&(i=c)),l.push(c)}return{values:l,min:i,max:r}}function i(){for(var t=0;t<4096;t++){var e=t%64*y,n=~~(t/64)*y,r=document.createElementNS(s,"rect");r.setAttributeNS(null,"x",e),r.setAttributeNS(null,"y",n),r.setAttributeNS(null,"width",y),r.setAttributeNS(null,"height",y),r.setAttributeNS(null,"class","spot"),c.appendChild(r)}p=c.getElementsByTagName("rect")}function l(t){for(var e=d/(Math.log(t.max)-Math.log(t.min)),n=v/Math.log(t.max),r=0,i=t.values.length;r<i;r++){var l=t.values[r];if(l>0){var o=Math.log(l)*e;if(o>d){var s=m-l*n;p[r].style.fill="hsla(0,100%,"+s+"%, 0.5)",p[r].style.stroke="hsla(0,100%,"+s+"%, 0.5)"}else{var a=d-o;p[r].style.fill="hsla("+a+",100%,"+m+"%, 0.4)",p[r].style.stroke="hsla("+a+",100%,"+m+"%, 0.4)"}}else p[r].style.fill="hsla(0,100%,0%,0)",p[r].style.stroke="hsla(0,100%,0%,0)"}}function o(){var t=new XMLHttpRequest,e=g[S];t.open("get",e,!0),t.onload=function(e){var n=t.response,o=r(n);console.log(JSON.stringify(o)),p?l(o):(i(),l(o))},t.onerror=function(t){console.log("error : "+JSON.stringify(t))},t.send(),f=setTimeout(o,2e4)}function a(){if(p)for(var t=0,e=p.length;t<e;t++)p[t].style.fill="hsla(0,100%,0%, 0)",p[t].style.stroke="hsla(0,100%,0%, 0)"}function u(){for(p=null;c.firstChild;)c.removeChild(c.firstChild)}var c,p,f,d=200,m=60,h=16,v=m-h,y=16,g=[location.origin+"/p360/hm_count",location.origin+"/p360/hm_loitering"],S="0";return{TypeEnum:{count:0,loitering:1},init:e,setScreenSize:n,start:function(t){S=t,clearTimeout(f),a(),o()},stop:function(){clearTimeout(f),a()}}}(),p=function(){function e(){u=document.getElementById("countLines")}function n(t){d=t/f,p&&(clearTimeout(c),a(),o())}function r(e){var n,r,i=t(e),l=[],o=0,s=0,a=i.split("\r\n"),u=a.length;if(u>2){var c=a[0].split(",");n=new Date(c[0].substr(0,4),c[0].substr(4,2)-1,c[0].substr(6,2),c[1].substr(0,2),c[1].substr(2,2),0,0),r=new Date(c[2].substr(0,4),c[2].substr(4,2)-1,c[2].substr(6,2),c[3].substr(0,2),c[3].substr(2,2),0,0);for(var p=1;p<u;p++){var f=a[p].split(",");if(6==f.length){var d=parseInt(f[4]),m=parseInt(f[5]);p<3&&(o+=d,s+=m),l.push({x1:parseInt(f[0]),y1:parseInt(f[1]),x2:parseInt(f[2]),y2:parseInt(f[3]),down:m,up:d})}}}return{begin:n,end:r,values:l,sumUp:o,sumDown:s}}function i(t){for(var e=t.values,n=0,r=e.length;n<r;n++){var i=e[n];if(i.x1!=i.x2||i.y1!=i.y2){var l=document.createElementNS(s,"line");l.setAttributeNS(null,"x1",i.x1*d),l.setAttributeNS(null,"y1",i.y1*d),l.setAttributeNS(null,"x2",i.x2*d),l.setAttributeNS(null,"y2",i.y2*d),l.setAttributeNS(null,"class","line"+n),u.appendChild(l);var o=i.x1<i.x2?i.y1<i.y2?1:-1:i.y1<i.y2?-1:1,a=(i.x1+i.x2)/2*d,c=(i.y1+i.y2)/2*d,m=Math.sqrt(Math.pow(i.x1-i.x2,2)+Math.pow(i.y1-i.y2,2)),h=Math.abs(i.x1-i.x2),v=180*Math.acos(h/m)/Math.PI*o,y=document.createElementNS(s,"text");y.setAttributeNS(null,"x",a),y.setAttributeNS(null,"y",c-10),y.setAttributeNS(null,"class","text text"+n),y.setAttributeNS(null,"transform","rotate("+Math.round(v)+","+a+","+c+")"),y.textContent=i.up,u.appendChild(y);var g=document.createElementNS(s,"text");g.setAttributeNS(null,"x",a),g.setAttributeNS(null,"y",c+25),g.setAttributeNS(null,"class","text text"+n),g.setAttributeNS(null,"transform","rotate("+Math.round(v)+","+a+","+c+")"),g.textContent=i.down,u.appendChild(g)}}var S=document.createElementNS(s,"text"),b=f/2*d,x=t.sumDown-t.sumUp;S.setAttributeNS(null,"x",b),S.setAttributeNS(null,"y",b),S.setAttributeNS(null,"class","textCount"),S.textContent=x>0?x:0,u.appendChild(S),p=u.getElementsByTagName("text")}function l(t){var e=p.length;if(e>1){for(var n=t.values,r=0,i=0;r<e-1;i++)2==i?(p[r++].innerHTML=n[i].up>0?n[i].up:" ",p[r++].innerHTML=n[i].down>0?n[i].down:" "):3==i?(p[r++].innerHTML=n[i].up,p[r++].innerHTML=n[i].down):(p[r++].innerHTML=n[i].up,p[r++].innerHTML=n[i].down);var l=t.sumDown-t.sumUp;p[e-1].innerHTML=l>0?l:0}}function o(){var t=new XMLHttpRequest,e=location.origin+"/p360/pp_count";t.open("get",e,!0),t.onload=function(e){var n=t.response,o=r(n);console.log(JSON.stringify(o)),p?l(o):i(o)},t.onerror=function(t){console.log("error : "+JSON.stringify(t))},t.send(),c=setTimeout(o,1e4)}function a(){for(p=null;u.firstChild;)u.removeChild(u.firstChild)}var u,c,p,f=320,d=1;return{init:e,setScreenSize:n,start:function(){clearTimeout(c),a(),o()},stop:function(){clearTimeout(c),a()}}}();return{init:e,setScreenSize:n,startVideo:function(){u=setInterval(r,a)},stopVideo:function(){c.stop(),p.stop(),u&&(clearInterval(u),u=null)},HeatMapTypeEnum:c.TypeEnum,startHeatMap:c.start,stopHeatMap:c.stop,startPeoplesCount:p.start,stopPeoplesCount:p.stop}}();document.addEventListener("DOMContentLoaded",t)})();