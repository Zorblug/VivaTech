"use strict";var SpaceInvaders=SpaceInvaders||{};SpaceInvaders.Alien=function(e,t,i,s){Phaser.Sprite.call(this,e,t,i,"ufo",s+"0"),this.animations.add("fly",Phaser.Animation.generateFrameNames(s,0,1,"",1),5,!0),this.animations.play("fly"),this.game.physics.enable(this,Phaser.Physics.ARCADE),this.checkWorldBounds=!0,this.body.collideWorldBounds=!0,this.body.velocity.y=70,this.body.bounce.x=1,this.body.bounce.y=.9,this.lifePoint=3,this.scorePoint=10},SpaceInvaders.Alien.prototype=Object.create(Phaser.Sprite.prototype,{constructor:SpaceInvaders.Alien}),SpaceInvaders.Alien.Keys=["Bleu-","Rouge-","Jaune-","Multicolor-","Vert-"],SpaceInvaders.Alien.preload=function(){game.load.atlas("ufo","/assets/ufo.png","/assets/ufo.json")},SpaceInvaders.Aliens=function(e){this.game=e,this.events=new ObservableEvents,this.indexSprites=0,this.enemyBullets,this.firingDelay=2e3,this.firingTimer=0,this.aliens,this.tween=void 0,this.shotAnimation,this.destroyAnimation},SpaceInvaders.Aliens.prototype={_createAliensAttack:function(){this.indexSprites=0,void 0==this.tween&&(this.tween=this.game.add.tween(this.aliens)),this.tween.onComplete.removeAll(),this.tween.onLoop.removeAll(),this.firingDelay=2e3,this._createAliens(),this.tween.onComplete.addOnce(this._alienGoBack,this),this.tween.onLoop.add(this._createAliens,this),this.tween.to({x:339},2e3,Phaser.Easing.Linear.None,!0,0,2,!0)},_alienGoBack:function(){this.firingDelay=1500,this.tween.onLoop.remove(this._createAliens,this),this.tween.to({x:339},1e3,Phaser.Easing.Linear.None,!0,0,2,!0),this.tween.onComplete.addOnce(this._aliensRandomMove,this)},_aliensRandomMove:function(){this.firingDelay=1e3;for(var e in this.aliens.children)this.aliens.children[e].scorePoint+=10,this.aliens.children[e].body.velocity.set(this.game.rnd.integerInRange(-400,400),this.game.rnd.integerInRange(-160,50))},_createAliens:function(){if(this.indexSprites<SpaceInvaders.Alien.Keys.length){for(var e=SpaceInvaders.Alien.Keys[this.indexSprites],t=0;t<4;t++){var i=new SpaceInvaders.Alien(this.game,200*t,0,e);i.scorePoint+=10*this.indexSprites,this.aliens.add(i)}this.indexSprites+=1}},_alienHitsPlayer:function(e,t){t.kill(),e.lives-=1,this.events.fire("alienHitPlayer",{id:e.id,lives:e.lives}),e.lives<1?(e.kill(),this.destroyAnimation.play(e.body.x,e.body.y),this.events.fire("alienKillPlayer",{id:e.id,lives:e.lives})):this.shotAnimation.play(e.body.x,e.body.y)},_alienCollidePlayer:function(e,t){e.lives-=2,this.events.fire("alienHitPlayer",{id:e.id,lives:e.lives}),t.kill(),this.destroyAnimation.play(t.body.x,t.body.y),e.lives<1?(e.kill(),this.destroyAnimation.play(e.body.x,e.body.y),this.events.fire("alienKillPlayer",{id:e.id,lives:e.lives})):this.shotAnimation.play(e.body.x+15,e.body.y-10)},preload:function(){SpaceInvaders.Alien.preload()},create:function(e,t){this.enemyBullets=this.game.add.group(),this.enemyBullets.enableBody=!0,this.enemyBullets.physicsBodyType=Phaser.Physics.ARCADE,this.enemyBullets.createMultiple(30,"ufo","bullet-1"),this.enemyBullets.setAll("anchor.x",.5),this.enemyBullets.setAll("anchor.y",.5),this.enemyBullets.setAll("outOfBoundsKill",!0),this.enemyBullets.setAll("checkWorldBounds",!0),this.enemyBullets.forEach(function(e){e.animations.add("fireEnemy",Phaser.Animation.generateFrameNames("bullet-",1,4,"",1),5,!0)},this),this.aliens=this.game.add.group(),this.aliens.enableBody=!0,this.aliens.physicsBodyType=Phaser.Physics.ARCADE,this.aliens.x=0,this.aliens.y=0,this.shotAnimation=e,this.destroyAnimation=t},update:function(e){this.game.time.now>this.firingTimer&&this.fire(e),this.game.physics.arcade.overlap(this.enemyBullets,e,this._alienHitsPlayer,null,this),this.game.physics.arcade.overlap(this.aliens,e,this._alienCollidePlayer,null,this)},updateAutoCollide:function(){this.game.physics.arcade.collide(this.aliens)},fire:function(e){var t=this.enemyBullets.getFirstExists(!1),i=[];if(this.aliens.forEachAlive(function(e){i.push(e)}),t&&i.length>0){var s=this.game.rnd.integerInRange(0,i.length-1),a=i[s];t.reset(a.body.x+70,a.body.y+85),t.play("fireEnemy"),this.game.physics.arcade.moveToObject(t,e,300),this.firingTimer=this.game.time.now+this.firingDelay}},clearAttack:function(){this.aliens.removeAll()},startAttack:function(){this._createAliensAttack()},countLiving:function(){var e=this.aliens.countLiving();return 0==e&&this.enemyBullets.callAll("kill",this),e},onAlienKillPlayer:function(e){this.events.addObserver("alienKillPlayer",e)},onAlienHitPlayer:function(e){this.events.addObserver("alienHitPlayer",e)}},SpaceInvaders.Ship=function(e,t,i,s){Phaser.Sprite.call(this,e,t,i,"fusee",SpaceInvaders.Ship.Keys[s]+"1"),e.physics.enable(this,Phaser.Physics.ARCADE),this.bullets=this.game.add.group(),this.bullets.enableBody=!0,this.bullets.physicsBodyType=Phaser.Physics.ARCADE,this.bullets.createMultiple(30,"fusee",SpaceInvaders.Ship.BulletKeys[s]),this.bullets.setAll("anchor.x",.5),this.bullets.setAll("anchor.y",1),this.bullets.setAll("outOfBoundsKill",!0),this.bullets.setAll("checkWorldBounds",!0),this.bulletTime=0,this.body.setSize(59,84),this.anchor.setTo(.5,.5),this.body.collideWorldBounds=!0,this.exists=!1,this.alive=!1,this.animations.add("player_fly",Phaser.Animation.generateFrameNames(SpaceInvaders.Ship.Keys[s],1,4,"",1),20,!0),this.play("player_fly"),this.id=void 0,this.lives=3,this.index=s,console.log("Player index : "+s)},SpaceInvaders.Ship.PlayersImg=["fusee_Bleu","fusee_Jaune","fusee_Rouge","fusee_Vert","fusee_Violet","fusee_Gris"],SpaceInvaders.Ship.Keys=["fusee_Bleu_","fusee_Jaune_","fusee_Rouge_","fusee_Vert_","fusee_Violet_","fusee_Gris_"],SpaceInvaders.Ship.BulletKeys=["bullet_Bleu","bullet_Jaune","bullet_Rouge","bullet_Vert","bullet_Violet","bullet_Gris"],SpaceInvaders.Ship.preload=function(){game.load.atlas("fusee","/assets/ship.png","/assets/ship.json")},SpaceInvaders.Ship.prototype=Object.create(Phaser.Sprite.prototype,{constructor:SpaceInvaders.Ship}),SpaceInvaders.Ship.prototype.fire=function(){if(this.game.time.now>this.bulletTime){var e=this.bullets.getFirstExists(!1);e&&(e.id=this.id,e.reset(this.x,this.y-55),e.body.velocity.y=-400,this.bulletTime=this.game.time.now+400)}};var playerVelocity=200;SpaceInvaders.Player=function(e,t,i){this.parent=e,this.joystick=i,this.player=t,this.score=0,console.log("Create Player : "+this.joystick.id)},SpaceInvaders.Player.prototype={constructor:SpaceInvaders.Player,destroy:function(){console.log("Delete Player : "+this.joystick.id),this.player.reset(100+100*this.player.index,1800),this.player.kill()},isAlive:function(){return this.player.alive},update:function(){this.joystick.left?this.player.body.velocity.x=-playerVelocity:this.joystick.right?this.player.body.velocity.x=playerVelocity:this.player.body.velocity.x=0,this.joystick.up?this.player.body.velocity.y=playerVelocity:this.joystick.down?this.player.body.velocity.y=-playerVelocity:this.player.body.velocity.y=0,this.joystick.button>0&&(this.joystick.button>1?this.parent.events.fire("playerStartGame",{id:this.joystick.id,data:this.joystick.button}):this.player.fire())}},SpaceInvaders.PlayerGroup=function(e,t,i){this.game=e,this.events=new ObservableEvents,this.shotAnimation=t,this.destroyAnimation=i,this.indexSprites=0,this.players=new Collection,this.playersGroup},SpaceInvaders.PlayerGroup.prototype={_playerHitsAlien:function(e,t){var i=t.scorePoint;if(e.kill(),t.lifePoint-=1,t.lifePoint<1)t.kill(),this.destroyAnimation.play(t.body.x,t.body.y);else if(this.shotAnimation.play(t.body.x,t.body.y),t.lifePoint<2){t.play("fly");var s=this.players.item(e.id);s&&this.game.physics.arcade.moveToObject(t,s.player,200),t.scorePoint+=20}this.events.fire("playerHitAlien",{id:e.id,point:i})},_playersCollide:function(e,t){console.log("COLLISION : "+e.id+" : "+t.id),this.events.fire("playersCollide",{A:e.id,B:t.id})},fire:function(e){e.fire()},createNewPLayer:function(e,t){var i=this.players.item(e);if(void 0===i){var s=this.playersGroup.getFirstExists(!1);return s?(s.id=e,s.lives=4,s.score=0,this.players.add(e,new SpaceInvaders.Player(this,s,t)),s.revive(),s):null}return i.player},countLiving:function(){return this.playersGroup.countLiving()},preload:function(){SpaceInvaders.Ship.preload()},create:function(){this.playersGroup=this.game.add.group();for(var e in SpaceInvaders.Ship.Keys)var t=this.playersGroup.add(new SpaceInvaders.Ship(this.game,100+100*e,1800,e))},update:function(e){var t=this;this.players.forEach(function(i){i.isAlive()&&(i.update(),e.update(i.player)),t.game.physics.arcade.overlap(i.player.bullets,e.aliens,t._playerHitsAlien,null,t)}),this.game.physics.arcade.collide(this.playersGroup,this.playersGroup,this._playersCollide,null,this)},remove:function(e){var t=this.players.item(e);t&&t.player.kill()},removeAll:function(){this.players.forEach(function(e){e.destroy()}),this.players.clear()},winner:function(){var e=void 0;return this.players.forEach(function(t){void 0==e?e=t:e.score<t.score&&(e=t)}),e},onPlayerHitAlien:function(e){this.events.addObserver("playerHitAlien",e)},onPlayerStartGame:function(e){this.events.addObserver("playerStartGame",e)},onPlayersCollide:function(e){this.events.addObserver("playersCollide",e)}},SpaceInvaders.Explosions=function(e,t){this.game=e,this.explosions,this.name=t},SpaceInvaders.Explosions.prototype={preload:function(e,t,i){this.game.load.spritesheet(this.name,e,t,i)},create:function(){this.explosions=this.game.add.group(),this.explosions.createMultiple(40,this.name),this.explosions.forEach(function(e){e.anchor.x=.5,e.anchor.y=.5,e.animations.add(this.name)},this)},play:function(e,t){var i=this.explosions.getFirstExists(!1);i&&(i.reset(e,t),i.play(this.name,30,!1,!0))}};var gameOverTimeOut=5e3;SpaceInvaders.Game=function(e){this.remoteInput,this.theAliens,this.litleExplosions,this.bigExplosions,this.thePlayers,this.starfield,this.fontText,this.stateText,this.title,this.gameStarted=!1},SpaceInvaders.Game.prototype={_showPLayerCount:function(){var e=this.thePlayers.countLiving();this.remoteInput.broadcast({state:"team",player:e}),this.gameStarted||(e>1?this.stateText.text=e+" PLAYERS CONNECTED":this.stateText.text=e+" PLAYER CONNECTED")},_newGame:function(){var e=this;setTimeout(function(){e.remoteInput.broadcast({state:"end"}),e.game.thePlayers=e.thePlayers,e.game.state.start("result")},gameOverTimeOut)},_sendPlayerCollide:function(e){var t=this.thePlayers.players.item(e);t&&t.joystick.send({state:"collide"})},init:function(){this.remoteInput=this.game.remoteInput,this.theAliens=new SpaceInvaders.Aliens(this.game),this.litleExplosions=new SpaceInvaders.Explosions(this.game,"ptikaboum"),this.bigExplosions=new SpaceInvaders.Explosions(this.game,"kaboom"),this.thePlayers=new SpaceInvaders.PlayerGroup(this.game,this.litleExplosions,this.bigExplosions);var e=this;this.theAliens.onAlienHitPlayer(function(t){console.log("Player Hit : "+JSON.stringify(t)),e.remoteInput.send(t.id,{state:"hit",lives:t.lives})}),this.theAliens.onAlienKillPlayer(function(t){console.log("Player Kill : "+JSON.stringify(t)),e.remoteInput.send(t.id,{state:"kill"}),e.thePlayers.countLiving()<1&&(e.stateText.text=" GAME OVER",e.stateText.visible=!0,e._newGame())}),this.thePlayers.onPlayerHitAlien(function(t){var i=e.thePlayers.players.item(t.id);if(i&&(i.score+=t.point,i.joystick.send({state:"score",score:i.score})),0==e.theAliens.countLiving()){e.theAliens.clearAttack();var s=e.thePlayers.winner();e.remoteInput.send(s.player.id,{state:"win",score:s.score,index:s.player.index}),e.stateText.text="WINNER IS ",e.stateText.x=e.world.centerX/2,e.game.add.image(e.world.centerX,200,SpaceInvaders.Ship.PlayersImg[s.player.index]),e.stateText.visible=!0,e._newGame()}}),this.thePlayers.onPlayersCollide(function(t){e._sendPlayerCollide(t.A),e._sendPlayerCollide(t.B)}),this.thePlayers.onPlayerStartGame(function(t){e.gameStarted||(e.gameStarted=!0,e.game.clearQR(),e.stateText.visible=!1,e.title.visible=!1,e.remoteInput.broadcast({state:"start",player:e.thePlayers.countLiving()}),e.theAliens.clearAttack(),e.theAliens.startAttack())}),this.remoteInput.onNewRemote(function(t){if(console.log("REMOTE :"+t.id+" index : "+t.index+" - "+t.joystick.stringify()),e.gameStarted)t.joystick.send({state:"close",why:"started"});else{var i=e.thePlayers.createNewPLayer(t.id,t.joystick);i?(e.theAliens.clearAttack(),t.joystick.send({state:"ready",score:0,lives:i.lives,index:i.index}),e._showPLayerCount()):t.joystick.send({state:"close",why:"full"})}}),this.remoteInput.onClearRemote(function(t){console.log("CLEAR REMOTE :"+t.id),e.thePlayers.remove(t.id),e._showPLayerCount()})},preload:function(){console.log("PRELOAD GAME"),this.theAliens.preload(),this.bigExplosions.preload("/assets/explode.png",128,128),this.litleExplosions.preload("/assets/explosion64_2.png",64,64),this.thePlayers.preload(),this.load.image("starfield","/assets/starfield.png"),this.game.load.image("title","/assets/Title.png"),this.load.image("fusee_Bleu","/assets/fusee_Bleu.png"),this.load.image("fusee_Jaune","/assets/fusee_Jaune.png"),this.load.image("fusee_Rouge","/assets/fusee_Rouge.png"),this.load.image("fusee_Vert","/assets/fusee_Vert.png"),this.load.image("fusee_Violet","/assets/fusee_Violet.png"),this.load.image("fusee_Gris","/assets/fusee_Gris.png")},create:function(){console.log("CREATE GAME"),this.gameStarted=!1,this.remoteInput.connect(),this.stage.setBackgroundColor(16777215),this.physics.startSystem(Phaser.Physics.ARCADE),this.starfield=this.add.tileSprite(0,0,1080,1920,"starfield"),this.theAliens.create(this.litleExplosions,this.bigExplosions),this.thePlayers.create(),this.stateText=this.add.text(this.world.centerX,270,"     Welcome to Rockets vs Aliens !\r\n  Connect to WiFi JCDecaux Gaming\r\nand get game pad by NFC or QR code",{font:"60px Arial",fill:"#ffc600"}),this.stateText.anchor.setTo(.5,0),this.stateText.visible=!0,this.title=this.game.add.image(this.world.centerX,this.world.centerY,"title"),this.title.anchor.setTo(.5,0),this.title.visible=!0,this.litleExplosions.create(),this.bigExplosions.create(),this.game.activeQR()},update:function(){this.starfield.tilePosition.y+=2,this.thePlayers.update(this.theAliens),this.theAliens.updateAutoCollide()}},SpaceInvaders.Result=function(e){},SpaceInvaders.Result.prototype={init:function(){},preload:function(){console.log("PRELOAD SCORE")},create:function(){console.log("CREATE SCORE"),this.stage.setBackgroundColor(0),this.starfield=this.add.tileSprite(0,0,1080,1920,"starfield"),this.add.text(this.world.centerX,200,"SCORE",{font:"90px Arial",fill:"#ffc600",align:"center"}).anchor.setTo(.5,0);var e=0,t=this;this.game.thePlayers.players.forEach(function(i){t.game.add.image(t.world.centerX/2,400+200*e,SpaceInvaders.Ship.PlayersImg[e]),t.add.text(t.world.centerX,400+200*e,i.score.toString(),{font:"80px Arial",fill:"#ffc600"}),e+=1}),setTimeout(function(){console.log("END OF GAME"),t.game.remoteInput.close()},15e3)},update:function(){this.starfield.tilePosition.y+=2}};